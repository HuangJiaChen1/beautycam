        h, w = image.shape[:2]
        if w >= 1920 or h >= 1080:
            image = cv2.resize(image, (w // 2, h // 2), interpolation=cv2.INTER_AREA)

        # Run model inference once for this image
        run_model_inference(image)
        # Auto-select first face if only one face detected, otherwise start with none
        if len(cached_face_landmarks) == 1:
            idx = 0
            selected_faces.add(idx)
            face_params[idx] = {p: defaults[p] for p in all_params}
            update_active_face(idx)
        update_image()


def save_image():
    global image_path, bg_blur_enabled
    image = cv2.imread(image_path)
    if image is None:
        error_label.config(text=f"Error: Could not load image at {image_path}")
        return

    h, w = image.shape[:2]
    if w >= 1920 or h >= 1080:
        image = cv2.resize(image, (w // 2, h // 2), interpolation=cv2.INTER_AREA)

    processed_image = process_image(
        image,
        selected_faces,
        apply_bg_blur=bg_blur_enabled
    )
    if processed_image is None:
        error_label.config(text="Error: Image processing failed.")
        return

    base_name = image_path.split('/')[-1].split('.')[0]
    blur_suffix = "_blur" if bg_blur_enabled else ""
    # Simplified filename since params are per face
    filename = f"{base_name}{blur_suffix}.jpg"

    cv2.imwrite(filename, processed_image)
    error_label.config(text=f"Image saved as {filename}")


root = tk.Tk()
root.title("美颜算法")

image_path = 'imgs/face4.jpg'
image_frame = tk.Frame(root)
image_frame.pack(side=tk.LEFT, padx=10, pady=10)
image_label = tk.Label(image_frame)
image_label.pack()
image_label.bind("<Button-1>", on_click)
error_label = tk.Label(image_frame, text="", fg="red")
error_label.pack()

control_frame = tk.Frame(root)
control_frame.pack(side=tk.RIGHT, padx=10, pady=10)
control_frame.grid_columnconfigure(0, weight=1)
control_frame.grid_columnconfigure(1, weight=1)
control_frame.grid_columnconfigure(2, weight=1)

DAYAN_var = tk.DoubleVar(value=DAYAN_DEFAULT)
SHOULIAN_var = tk.DoubleVar(value=SHOULIAN_DEFAULT)
ZHAILIAN_var = tk.DoubleVar(value=ZHAILIAN_DEFAULT)
FOREHEAD_var = tk.DoubleVar(value=FOREHEAD_DEFAULT)
RENZHONG_var = tk.DoubleVar(value=RENZHONG_DEFAILT)
QUANGU_var = tk.DoubleVar(value=QUANGU_DEFAULT)
BIYI_var = tk.DoubleVar(value=BIYI_DEFAULT)
LONGNOSE_var = tk.DoubleVar(value=LONGNOSE_DEFAULT)
DETAIL_var = tk.DoubleVar(value=0)
S_var = tk.DoubleVar(value=S_DEFAULT)
V_var = tk.DoubleVar(value=V_DEFAULT)
MOPI_var = tk.DoubleVar(value=MOPI_DEFAULT)
FALING_var = tk.DoubleVar(value=FALING_DEFAULT)
BLACK_var = tk.DoubleVar(value=BLACK_DEFAULT)
WHITE_EYE_var = tk.DoubleVar(value=WHITE_EYE_DEFAULT)
WHITE_TEETH_var = tk.DoubleVar(value=WHITE_TEETH_DEFAULT)
LIPSTICK_var = tk.DoubleVar(value=LIPSTICK_DEFAULT)
BLUSH_var = tk.DoubleVar(value=BLUSH_DEFAULT)
ZUIJIAO_var = tk.DoubleVar(value=ZUIJIAO_DEFAULT)
DAZUI_var = tk.DoubleVar(value=DAZUI_DEFAULT)

tk.Scale(control_frame, from_=1.0, to=1.1, resolution=0.01, orient=tk.HORIZONTAL, label="大眼", variable=DAYAN_var,
         command=make_slider_command('DAYAN')).grid(row=0, column=0, padx=5, pady=5, sticky="ew")
tk.Scale(control_frame, from_=0.95, to=1.0, resolution=0.005, orient=tk.HORIZONTAL, label="瘦脸", variable=SHOULIAN_var,
         command=make_slider_command('SHOULIAN')).grid(row=0, column=1, padx=5, pady=5, sticky="ew")
tk.Scale(control_frame, from_=0.95, to=1.0, resolution=0.005, orient=tk.HORIZONTAL, label="颧骨", variable=QUANGU_var,
         command=make_slider_command('QUANGU')).grid(row=0, column=2, padx=5, pady=5, sticky="ew")
tk.Scale(control_frame, from_=-3.0, to=3.0, resolution=0.005, orient=tk.HORIZONTAL, label="人中", variable=RENZHONG_var,
         command=make_slider_command('RENZHONG')).grid(row=1, column=2, padx=5, pady=5, sticky="ew")
tk.Scale(control_frame, from_=-5.0, to=5.0, resolution=0.005, orient=tk.HORIZONTAL, label="额头", variable=FOREHEAD_var,
         command=make_slider_command('FOREHEAD')).grid(row=2, column=2, padx=5, pady=5, sticky="ew")
tk.Scale(control_frame, from_=0.95, to=1.0, resolution=0.005, orient=tk.HORIZONTAL, label="窄脸", variable=ZHAILIAN_var,
         command=make_slider_command('ZHAILIAN')).grid(row=1, column=0, padx=5, pady=5, sticky="ew")
tk.Scale(control_frame, from_=0.9, to=1.1, resolution=0.005, orient=tk.HORIZONTAL, label="鼻翼", variable=BIYI_var,
         command=make_slider_command('BIYI')).grid(row=1, column=1, padx=5, pady=5, sticky="ew")
tk.Scale(control_frame, from_=-2.0, to=2.0, resolution=0.005, orient=tk.HORIZONTAL, label="长鼻", variable=LONGNOSE_var,
         command=make_slider_command('LONGNOSE')).grid(row=2, column=1, padx=5, pady=5, sticky="ew")
tk.Scale(control_frame, from_=0.0, to=3.0, resolution=0.005, orient=tk.HORIZONTAL, label="嘴角", variable=ZUIJIAO_var,
         command=make_slider_command('ZUIJIAO')).grid(row=2, column=0, padx=5, pady=5, sticky="ew")
tk.Scale(control_frame, from_=0.9, to=1.1, resolution=0.005, orient=tk.HORIZONTAL, label="大嘴", variable=DAZUI_var,
         command=make_slider_command('DAZUI')).grid(row=3, column=2, padx=5, pady=5, sticky="ew")
tk.Scale(control_frame, from_=0.0, to=0.08, resolution=0.002, orient=tk.HORIZONTAL, label="美白", variable=S_var,
         command=make_slider_command('S')).grid(row=3, column=0, padx=5, pady=5, sticky="ew")
tk.Scale(control_frame, from_=0, to=0.5, resolution=0.01, orient=tk.HORIZONTAL, label="磨皮", variable=MOPI_var,
         command=make_slider_command('MOPI')).grid(row=5, column=0, padx=5, pady=5, sticky="ew")
tk.Scale(control_frame,
         from_=0, to=50, resolution=1,
         orient=tk.HORIZONTAL,
         label="细节增强",
         variable=DETAIL_var,
         command=make_slider_command('DETAIL')).grid(row=5, column=1, padx=5, pady=5, sticky="ew")
tk.Scale(control_frame,
         from_=0, to=1, resolution=0.02,
         orient=tk.HORIZONTAL,
         label="去法令纹",
         variable=FALING_var,
         command=make_slider_command('FALING')).grid(row=6, column=0, padx=5, pady=5, sticky="ew")
tk.Scale(control_frame,
         from_=0, to=1, resolution=0.02,
         orient=tk.HORIZONTAL,
         label="去黑眼圈",
         variable=BLACK_var,
         command=make_slider_command('BLACK')).grid(row=6, column=1, padx=5, pady=5, sticky="ew")
tk.Scale(control_frame,
         from_=1, to=1.2, resolution=0.02,
         orient=tk.HORIZONTAL,
         label="亮眼",
         variable=WHITE_EYE_var,
         command=make_slider_command('WHITE_EYE')).grid(row=7, column=0, padx=5, pady=5, sticky="ew")
tk.Scale(control_frame,
         from_=1, to=1.2, resolution=0.01,
         orient=tk.HORIZONTAL,
         label="亮牙",
         variable=WHITE_TEETH_var,
         command=make_slider_command('WHITE_TEETH')).grid(row=7, column=1, padx=5, pady=5, sticky="ew")
tk.Scale(control_frame,
         from_=0.0, to=0.5, resolution=0.01,
         orient=tk.HORIZONTAL,
         label="口红",
         variable=LIPSTICK_var,
         command=make_slider_command('LIPSTICK')).grid(row=8, column=0, padx=5, pady=5, sticky="ew")
tk.Scale(control_frame,
         from_=0.0, to=1, resolution=0.05,
         orient=tk.HORIZONTAL,
         label="腮红",
         variable=BLUSH_var,
         command=make_slider_command('BLUSH')).grid(row=8, column=1, padx=5, pady=5, sticky="ew")

param_to_var = {
    'DAYAN': DAYAN_var,
    'SHOULIAN': SHOULIAN_var,
    'QUANGU': QUANGU_var,
    'RENZHONG': RENZHONG_var,
    'FOREHEAD': FOREHEAD_var,
    'ZHAILIAN': ZHAILIAN_var,
    'BIYI': BIYI_var,
    'LONGNOSE': LONGNOSE_var,
    'ZUIJIAO': ZUIJIAO_var,
    'DAZUI': DAZUI_var,
    'S': S_var,
    'V': V_var,
    'MOPI': MOPI_var,
    'DETAIL': DETAIL_var,
    'FALING': FALING_var,
    'BLACK': BLACK_var,
    'WHITE_EYE': WHITE_EYE_var,
    'WHITE_TEETH': WHITE_TEETH_var,
    'LIPSTICK': LIPSTICK_var,
    'BLUSH': BLUSH_var,
}

active_label = tk.Label(control_frame, text="Editing: None", font=("Arial", 12, "bold"))
active_label.grid(row=9, column=0, columnspan=3, pady=5)

open_button = tk.Button(control_frame, text="打开图片", command=open_image)
open_button.grid(row=10, column=0, columnspan=2, padx=5, pady=5, sticky="ew")

blur_button = tk.Button(control_frame, text="模糊背景", command=toggle_bg_blur, bg="#4CAF50", fg="white",
                        font=("Arial", 10, "bold"))
blur_button.grid(row=11, column=0, columnspan=2, padx=5, pady=5, sticky="ew")

save_button = tk.Button(control_frame, text="保存图片", command=save_image)
save_button.grid(row=12, column=0, columnspan=2, padx=5, pady=5, sticky="ew")

# Load initial image and run inference
face_params = {}
selected_faces = set()
active_face = None
initial_image = cv2.imread(image_path)
if initial_image is not None:
    h, w = initial_image.shape[:2]
    if w >= 1920 or h >= 1080:
        initial_image = cv2.resize(initial_image, (w // 2, h // 2), interpolation=cv2.INTER_AREA)
    run_model_inference(initial_image)
    # Auto-select first face if only one face detected, otherwise start with none
    if len(cached_face_landmarks) == 1:
        idx = 0
        selected_faces.add(idx)
